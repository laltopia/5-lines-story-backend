function escapeHtml(e){return"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}console.log("ai.js loaded successfully"),console.log("submitInput function will be defined below");let appState={currentStep:1,userInput:"",suggestedPaths:[],selectedPath:null,customPath:"",currentStory:null,conversationId:null,editingLine:null,editingOriginalContent:null};function showNotification(e,t="success"){const n=document.createElement("div"),o={success:"#10b981",error:"#ef4444",info:"#6366f1"};n.style.cssText=`\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    background: ${o[t]||o.success};\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    z-index: 10000;\n    animation: slideIn 0.3s ease-out;\n    max-width: 400px;\n    font-size: 15px;\n    line-height: 1.5;\n  `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-out",setTimeout(()=>n.remove(),300)},"error"===t?5e3:3e3)}function handleApiError(e,t="Operation"){return console.error(`Error in ${t}:`,e),navigator.onLine?429===e.status||e.message?.includes("429")?"Too many requests. Please wait a moment and try again.":401===e.status||e.message?.includes("401")?"Your session has expired. Please refresh the page and sign in again.":e.status>=500?"Our servers are experiencing issues. Please try again in a moment.":e.message?.includes("fetch")||e.message?.includes("network")?"Network error. Please check your connection and try again.":e.message||"Something went wrong. Please try again.":"You appear to be offline. Please check your internet connection and try again."}async function fetchWithRetry(e,t={},n=2){for(let o=0;o<=n;o++)try{const i=await fetch(e,t);if(i.ok)return i;if(i.status>=400&&i.status<500&&429!==i.status){const e=new Error(`Request failed with status ${i.status}`);throw e.status=i.status,e}if(o<n){const e=1e3*Math.pow(2,o);console.log(`Retrying after ${e}ms... (attempt ${o+1}/${n})`),await new Promise(t=>setTimeout(t,e));continue}const a=new Error(`Request failed with status ${i.status}`);throw a.status=i.status,a}catch(e){if(o<n&&(e.message?.includes("fetch")||e.message?.includes("network"))){const e=1e3*Math.pow(2,o);console.log(`Network error, retrying after ${e}ms...`),await new Promise(t=>setTimeout(t,e));continue}throw e}}function setButtonLoading(e,t,n=null){const o=document.getElementById(e);o&&(t?(o.disabled=!0,o.dataset.originalText=o.innerHTML,o.innerHTML=`\n      <svg style="width: 20px; height: 20px; animation: spin 1s linear infinite;" viewBox="0 0 24 24">\n        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>\n        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/>\n      </svg>\n      <span style="margin-left: 8px;">${n||"Loading..."}</span>\n    `):(o.disabled=!1,o.dataset.originalText&&(o.innerHTML=o.dataset.originalText)))}if(!document.getElementById("loading-animations")){const e=document.createElement("style");e.id="loading-animations",e.textContent="\n    @keyframes spin {\n      from { transform: rotate(0deg); }\n      to { transform: rotate(360deg); }\n    }\n    @keyframes slideIn {\n      from {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n      to {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n    @keyframes slideOut {\n      from {\n        transform: translateX(0);\n        opacity: 1;\n      }\n      to {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n    }\n  ",document.head.appendChild(e)}async function loadUsage(){try{const e=await window.Clerk.session.getToken(),t=await fetch("/api/ai/usage",{headers:{Authorization:`Bearer ${e}`}}),n=await t.json();if(n.success){const{stories:e}=n.usage;document.getElementById("usageText").textContent=`${e.remaining} stories remaining this month`,document.getElementById("usageNumbers").textContent=`${e.used}/${e.limit} stories`,document.getElementById("progressFill").style.width=`${e.percentage}%`,e.percentage>80?document.getElementById("progressFill").style.background="#ef4444":e.percentage>60&&(document.getElementById("progressFill").style.background="#f59e0b")}}catch(e){console.error("Error loading usage:",e)}}function goToStep(e){appState.currentStep=e,document.querySelectorAll(".step").forEach((t,n)=>{t.classList.remove("active","completed"),n+1===e?t.classList.add("active"):n+1<e&&t.classList.add("completed")}),document.getElementById("inputStep").classList.toggle("hidden",1!==e),document.getElementById("pathStep").classList.toggle("hidden",2!==e),document.getElementById("storyStep").classList.toggle("hidden",3!==e)}async function submitInput(){const e=document.getElementById("userInput").value.trim();if(console.log("submitInput called, input length:",e.length),!e)return void showNotification("Please enter your story idea","error");if(e.length<10)return void showNotification("Please enter at least 10 characters for your story idea","error");console.log("Input valid, proceeding..."),appState.userInput=e,goToStep(2);const t=document.getElementById("loading1");t.classList.remove("hidden"),t.querySelector("p").textContent="AI is analyzing your idea and generating story paths...",document.getElementById("pathsGrid").innerHTML="",setButtonLoading("submitInputBtn",!0,"Analyzing...");try{console.log("Getting Clerk token...");const n=await window.Clerk.session.getToken();console.log("Token obtained:",n?"YES":"NO"),console.log("Sending request to /api/ai/suggest-paths");const o=await fetchWithRetry("/api/ai/suggest-paths",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({userInput:e})});console.log("Response status:",o.status);const i=await o.json();if(console.log("Response data:",i),t.classList.add("hidden"),setButtonLoading("submitInputBtn",!1),i.success)console.log("Success! Paths:",i.paths),appState.suggestedPaths=i.paths,renderPaths(i.paths),await loadUsage(),showNotification("3 story paths generated! Choose one or describe your own.","success");else if("Limit reached"===i.error)console.error("Limit reached:",i.message),showNotification(i.message,"error"),goToStep(1);else{console.error("Error from server:",i.error,i.details);showNotification(i.error||"Error generating paths","error"),goToStep(1)}}catch(e){t.classList.add("hidden"),setButtonLoading("submitInputBtn",!1),console.error("Exception in submitInput:",e);showNotification(handleApiError(e,"generating story paths"),"error"),goToStep(1)}}function renderPaths(e){console.log("renderPaths called with",e.length,"paths");document.getElementById("pathsGrid").innerHTML=e.map((e,t)=>`\n    <div class="path-card" id="path-${t}" data-index="${t}">\n      <div class="path-title">${escapeHtml(e.title)}</div>\n      <div class="path-description">${escapeHtml(e.description)}</div>\n      <div class="path-focus">${escapeHtml(e.focus)}</div>\n    </div>\n  `).join(""),console.log("Attaching click handlers to path cards..."),e.forEach((e,t)=>{const n=document.getElementById(`path-${t}`);n?(n.addEventListener("click",function(){console.log(`Path card ${t} clicked:`,e.title),selectPath(t)}),console.log(`Click handler attached to path-${t}`)):console.error(`Path card path-${t} not found!`)}),console.log("All path card handlers attached successfully")}function selectPath(e){console.log("selectPath called with index:",e),console.log("Available paths:",appState.suggestedPaths.length),document.querySelectorAll(".path-card").forEach(e=>{e.classList.remove("selected")});const t=document.getElementById(`path-${e}`);t?(t.classList.add("selected"),console.log("Path card marked as selected:",t)):console.error("Could not find path card:",`path-${e}`),appState.selectedPath=appState.suggestedPaths[e],console.log("Selected path:",appState.selectedPath),document.getElementById("customPath").value="",appState.customPath=""}async function generateStory(){const e=document.getElementById("customPath").value.trim();if(!appState.selectedPath&&!e)return void showNotification("Please select a path or describe your own","error");e&&(appState.customPath=e,appState.selectedPath=null),goToStep(3);const t=document.getElementById("loading2");t.classList.remove("hidden"),t.querySelector("p").textContent="AI is crafting your 5-line story... This may take 10-15 seconds.",document.getElementById("storyLines").innerHTML="",setButtonLoading("generateStoryBtn",!0,"Generating Story...");try{const e=await window.Clerk.session.getToken(),n=await fetchWithRetry("/api/ai/generate-story",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({userInput:appState.userInput,selectedPath:appState.selectedPath,customDescription:appState.customPath||null})}),o=await n.json();if(t.classList.add("hidden"),setButtonLoading("generateStoryBtn",!1),o.success)appState.currentStory=o.story,appState.conversationId=o.conversationId,renderStory(o.story),await loadUsage(),showNotification("Story created successfully! You can edit any line or save it.","success");else if("Limit reached"===o.error)showNotification(o.message,"error"),goToStep(2);else{showNotification(o.error||"Error generating story","error"),goToStep(2)}}catch(e){t.classList.add("hidden"),setButtonLoading("generateStoryBtn",!1),console.error("Error:",e);showNotification(handleApiError(e,"generating story"),"error"),goToStep(2)}}function renderStory(e){const t=document.getElementById("storyLines"),n=["Context / Initial Situation","Desire / Objective","Obstacle / Conflict","Action / Attempt","Result / Transformation"];t.innerHTML=Object.keys(e).map((t,o)=>{const i=o+1;return`\n      <div class="story-line" id="line-container-${i}">\n        <div class="line-label">\n          <div class="line-number">${i}</div>\n          <span>${escapeHtml(n[o])}</span>\n        </div>\n        <div class="line-content editable" id="line-content-${i}" data-line="${i}">\n          ${escapeHtml(e[t])}\n        </div>\n      </div>\n    `}).join(""),console.log("Attaching click handlers to story lines...");for(let e=1;e<=5;e++){const t=document.getElementById(`line-content-${e}`);t&&(t.addEventListener("click",function(){console.log(`Story line ${e} clicked for editing`),editLine(e)}),console.log(`âœ“ Click handler attached to line ${e}`))}}async function editLine(e){if(console.log(`editLine called for line ${e}`),appState.editingLine===e)return void console.log(`Already editing line ${e}, ignoring duplicate call`);appState.editingLine&&appState.editingLine!==e&&await saveEditDirectly(!1),appState.editingLine=e;const t=document.getElementById(`line-content-${e}`),n=t.textContent.trim();appState.editingOriginalContent=n,t.classList.add("editing"),t.classList.remove("editable"),t.innerHTML=`\n    <textarea\n      id="edit-textarea-${e}"\n      style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #6366f1; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;"\n    >${n}</textarea>\n    <div style="display: flex; gap: 8px; margin-top: 12px; padding: 12px; background: white; align-items: center;">\n      <button\n        id="cancel-edit-btn-${e}"\n        class="btn btn-secondary"\n        style="padding: 10px 20px;"\n      >\n        Cancel\n      </button>\n      <button\n        id="save-edit-btn-${e}"\n        style="width: 40px; height: 40px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s;"\n        title="Save"\n      >\n        âœ“\n      </button>\n      <button\n        id="refine-ai-btn-${e}"\n        class="btn btn-primary"\n        style="padding: 10px 20px; flex: 1;"\n      >\n        âœ¨ Refine with AI\n      </button>\n    </div>\n  `;const o=document.getElementById(`cancel-edit-btn-${e}`),i=document.getElementById(`save-edit-btn-${e}`),a=document.getElementById(`refine-ai-btn-${e}`);o&&o.addEventListener("click",function(e){e.preventDefault(),console.log("Cancel edit button clicked"),cancelEdit()}),i&&(i.addEventListener("click",function(e){e.preventDefault(),console.log("Save edit button clicked"),saveEditDirectly(!0)}),i.addEventListener("mouseover",function(){this.style.background="#059669"}),i.addEventListener("mouseout",function(){this.style.background="#10b981"})),a&&a.addEventListener("click",function(e){e.preventDefault(),console.log("Refine with AI button clicked"),saveEditWithAI()}),console.log("Edit mode activated with all event listeners attached");const s=document.getElementById(`edit-textarea-${e}`);s&&(s.focus(),s.setSelectionRange(s.value.length,s.value.length))}function cancelEdit(){if(!appState.editingLine)return;const e=appState.editingLine,t=appState.editingOriginalContent;let n=document.getElementById(`line-content-${e}`);n.classList.remove("editing"),n.classList.add("editable"),n.textContent=t;const o=n.cloneNode(!0);n.replaceWith(o),n=o,n.addEventListener("click",function(){console.log(`Story line ${e} clicked for editing after cancel`),editLine(e)}),appState.editingLine=null,appState.editingOriginalContent=null,console.log(`Edit cancelled for line ${e}, original text restored`)}async function saveEditDirectly(e=!0){if(!appState.editingLine)return;const t=appState.editingLine,n=document.getElementById(`edit-textarea-${t}`);if(!n)return;const o=n.value.trim();if(!o)return void alert("Please enter some text");const i=`line${t}`;appState.currentStory[i]=o;let a=document.getElementById(`line-content-${t}`);a.classList.remove("editing"),a.classList.add("editable"),a.textContent=o;const s=a.cloneNode(!0);a.replaceWith(s),a=s,a.addEventListener("click",function(){console.log(`Story line ${t} clicked for editing after save`),editLine(t)}),appState.editingLine=null,appState.editingOriginalContent=null,e&&showNotification(`Line ${t} saved! âœ…`),console.log(`Line ${t} saved directly:`,o.substring(0,50)+"...")}async function saveEditWithAI(){if(!appState.editingLine)return;const e=appState.editingLine,t=document.getElementById(`edit-textarea-${e}`);if(!t)return;const n=t.value.trim();if(!n)return void showNotification("Please enter your suggestion for the AI","error");const o=document.getElementById(`refine-ai-btn-${e}`);o&&(o.disabled=!0,o.textContent="Refining...");document.getElementById(`line-content-${e}`).innerHTML='\n    <div style="text-align: center; padding: 20px;">\n      <div class="spinner"></div>\n      <p style="margin-top: 12px; color: var(--text-secondary);">AI is refining your line... This may take a moment.</p>\n    </div>\n  ';try{const t=await window.Clerk.session.getToken(),o=await fetchWithRetry("/api/ai/refine-line",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({currentStory:appState.currentStory,lineNumber:e,userSuggestion:n,conversationId:appState.conversationId})}),i=await o.json();if(i.success){appState.currentStory=i.story,appState.editingLine=null,appState.editingOriginalContent=null,renderStory(i.story);showNotification(`Line ${e} refined!${i.explanation?` ${i.explanation}`:""}`,"success"),await loadUsage()}else{showNotification(i.error||"Error refining line","error"),cancelEdit()}}catch(e){console.error("Error:",e);showNotification(handleApiError(e,"refining line"),"error"),cancelEdit()}}async function saveAndGoToHistory(){appState.conversationId?(showNotification("Story saved! Redirecting to history...","success"),setTimeout(()=>{window.location.href="/history.html"},1500)):showNotification("No story to save yet. Please create a story first.","error")}function startOver(){confirm("Start over? Your current story will be lost.")&&(appState={currentStep:1,userInput:"",suggestedPaths:[],selectedPath:null,customPath:"",currentStory:null,conversationId:null,editingLine:null,editingOriginalContent:null},document.getElementById("userInput").value="",document.getElementById("customPath").value="",goToStep(1))}function shareStory(){if(!appState.currentStory)return;const e=`My Story:\n\n${Object.entries(appState.currentStory).map(([e,t],n)=>`${n+1}. ${t}`).join("\n\n")}\n\nCreated with StoryMaking.AI`;navigator.clipboard.writeText(e).then(()=>{showNotification("Story copied to clipboard! ðŸ“‹")}).catch(t=>{const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0,0,0,0.5);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 1000;\n    ",n.innerHTML=`\n      <div style="background: white; border-radius: 16px; padding: 32px; max-width: 600px; margin: 20px;">\n        <h3 style="margin-bottom: 16px;">Your Story</h3>\n        <textarea readonly style="width: 100%; min-height: 300px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">${escapeHtml(e)}</textarea>\n        <button id="close-story-modal-btn" class="btn btn-primary btn-full" style="margin-top: 16px;">Close</button>\n      </div>\n    `,document.body.appendChild(n);const o=document.getElementById("close-story-modal-btn");o&&o.addEventListener("click",function(e){e.preventDefault(),console.log("Story modal close button clicked"),n.remove()}),n.addEventListener("click",function(e){e.target===n&&(console.log("Clicked outside modal, closing"),n.remove())})})}console.log("submitInput function defined:",typeof submitInput),document.addEventListener("keydown",e=>{"Escape"===e.key&&appState.editingLine&&cancelEdit(),e.ctrlKey&&"Enter"===e.key&&appState.editingLine&&saveEditDirectly(!0),e.ctrlKey&&e.shiftKey&&"Enter"===e.key&&appState.editingLine&&saveEditWithAI()});
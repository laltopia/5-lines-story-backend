function escapeHtml(e){return"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}let appState={stories:[],filteredStories:[],currentStory:null};function handleApiError(e,t="Operation"){return console.error(`Error in ${t}:`,e),navigator.onLine?429===e.status||e.message?.includes("429")?"Too many requests. Please wait a moment and try again.":401===e.status||e.message?.includes("401")?"Your session has expired. Please refresh the page and sign in again.":e.status>=500?"Our servers are experiencing issues. Please try again in a moment.":e.message?.includes("fetch")||e.message?.includes("network")?"Network error. Please check your connection and try again.":e.message||"Something went wrong. Please try again.":"You appear to be offline. Please check your internet connection and try again."}async function fetchWithRetry(e,t={},n=2){for(let i=0;i<=n;i++)try{const s=await fetch(e,t);if(s.ok)return s;if(s.status>=400&&s.status<500&&429!==s.status){const e=new Error(`Request failed with status ${s.status}`);throw e.status=s.status,e}if(i<n){const e=1e3*Math.pow(2,i);console.log(`Retrying after ${e}ms...`),await new Promise(t=>setTimeout(t,e));continue}const o=new Error(`Request failed with status ${s.status}`);throw o.status=s.status,o}catch(e){if(i<n&&(e.message?.includes("fetch")||e.message?.includes("network"))){const e=1e3*Math.pow(2,i);console.log(`Network error, retrying after ${e}ms...`),await new Promise(t=>setTimeout(t,e));continue}throw e}}async function loadStories(){const e=document.getElementById("loading"),t=document.getElementById("storiesGrid"),n=document.getElementById("emptyState");e.classList.remove("hidden"),t.classList.add("hidden"),n.classList.add("hidden");try{const i=await window.Clerk.session.getToken(),s=await fetchWithRetry("/api/ai/history",{headers:{Authorization:`Bearer ${i}`}}),o=await s.json();e.classList.add("hidden"),o.success&&o.conversations.length>0?(appState.stories=o.conversations,appState.filteredStories=o.conversations,renderStories(o.conversations),t.classList.remove("hidden")):n.classList.remove("hidden")}catch(t){console.error("Error loading stories:",t),e.classList.add("hidden");showNotification(handleApiError(t,"loading stories"),"error"),n.classList.remove("hidden")}}function renderStories(e){const t=document.getElementById("storiesGrid");if(0===e.length)return document.getElementById("emptyState").classList.remove("hidden"),void t.classList.add("hidden");t.innerHTML=e.map(e=>{const t=JSON.parse(e.ai_response),n=new Date(e.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),i=e.title||Object.values(t)[0]?.substring(0,50)+"..."||"Untitled Story";return`\n      <div class="story-card" data-story-id="${e.id}">\n        <div class="story-header">\n          <div class="story-date">${escapeHtml(n)}</div>\n          <div class="story-actions">\n            <button class="icon-button share-btn" data-story-id="${e.id}" title="Share">\n              <svg class="icon">\n                <use href="#icon-share"></use>\n              </svg>\n            </button>\n            <button class="icon-button delete-btn" data-story-id="${e.id}" title="Delete">\n              <svg class="icon">\n                <use href="#icon-trash"></use>\n              </svg>\n            </button>\n          </div>\n        </div>\n\n        <div style="margin-bottom: 16px;">\n          <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin: 0; line-height: 1.4;">\n            ${escapeHtml(i)}\n          </h3>\n        </div>\n\n        <div class="story-preview">\n          ${Object.entries(t).slice(0,3).map(([e,t],n)=>`\n            <div class="story-line">\n              <div class="line-number">${n+1}</div>\n              <div class="line-text">${escapeHtml(t)}</div>\n            </div>\n          `).join("")}\n          ${Object.keys(t).length>3?'<div style="text-align: center; color: #9ca3af; font-size: 12px; margin-top: 8px;">... +2 more lines</div>':""}\n        </div>\n\n        <div class="story-footer">\n          <span>${e.tokens_used} tokens</span>\n          <span>5 lines</span>\n        </div>\n      </div>\n    `}).join(""),attachStoryCardListeners()}function attachStoryCardListeners(){const e=document.getElementById("storiesGrid");"true"!==e.dataset.listenerAttached?(e.addEventListener("click",e=>{const t=e.target.closest(".share-btn");if(t){e.stopPropagation();return void shareStory(t.dataset.storyId)}const n=e.target.closest(".delete-btn");if(n){e.stopPropagation();return void deleteStory(n.dataset.storyId)}const i=e.target.closest(".story-card");if(i){return void openStoryModal(i.dataset.storyId)}}),e.dataset.listenerAttached="true",console.log("Story card event listeners attached via event delegation")):console.log("Event listeners already attached, skipping")}function filterStories(){const e=document.getElementById("searchInput").value.toLowerCase();appState.filteredStories=e?appState.stories.filter(t=>{const n=JSON.parse(t.ai_response),i=Object.values(n).join(" ").toLowerCase(),s=t.user_input.toLowerCase();return i.includes(e)||s.includes(e)}):appState.stories,renderStories(appState.filteredStories)}function openStoryModal(e){const t=appState.stories.find(t=>t.id===e);if(!t)return;appState.currentStory=t;const n=JSON.parse(t.ai_response),i=new Date(t.created_at).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}),s=["Context / Initial Situation","Desire / Objective","Obstacle / Conflict","Action / Attempt","Result / Transformation"],o=t.title||Object.values(n)[0]?.substring(0,50)+"..."||"Untitled Story";document.getElementById("modalTitle").textContent=`Story from ${i}`;document.getElementById("modalBody").innerHTML=`\n    \x3c!-- Title Section (Editable) --\x3e\n    <div style="margin-bottom: 24px;">\n      <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">\n        <span>Story Title</span>\n        <button class="icon-button" id="editTitleBtn" title="Edit title">\n          <svg class="icon icon-sm">\n            <use href="#icon-edit"></use>\n          </svg>\n        </button>\n      </div>\n      <div id="titleDisplay" style="font-size: 20px; font-weight: 600; color: #111827; padding: 12px; background: #f9fafb; border-radius: 12px; cursor: pointer;">\n        ${escapeHtml(o)}\n      </div>\n      <div id="titleEdit" class="hidden">\n        <input\n          type="text"\n          id="titleInput"\n          value="${escapeHtml(o)}"\n          style="width: 100%; padding: 12px; border: 2px solid #6366f1; border-radius: 12px; font-size: 18px; font-weight: 600; font-family: inherit;"\n        />\n        <div style="display: flex; gap: 8px; margin-top: 8px;">\n          <button class="btn btn-secondary" id="cancelTitleBtn" style="padding: 8px 16px;">Cancel</button>\n          <button class="btn btn-primary" id="saveTitleBtn" style="padding: 8px 16px;">Save</button>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- Original Input --\x3e\n    <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 24px;">\n      <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 8px;">\n        Original Input\n      </div>\n      <div style="font-size: 14px; color: #374151; line-height: 1.6;">\n        ${escapeHtml(t.user_input)}\n      </div>\n    </div>\n\n    \x3c!-- Story Lines (Editable) --\x3e\n    ${Object.entries(n).map(([e,t],n)=>`\n      <div class="modal-story-line" data-line-number="${n+1}">\n        <div class="modal-line-label">\n          <div class="line-number">${n+1}</div>\n          <span>${escapeHtml(s[n])}</span>\n          <button class="icon-button edit-line-btn" data-line="${n+1}" title="Edit line" style="margin-left: auto;">\n            <svg class="icon icon-sm">\n              <use href="#icon-edit"></use>\n            </svg>\n          </button>\n        </div>\n        <div class="modal-line-content editable-line" id="lineDisplay-${n+1}" data-line="${n+1}">\n          ${escapeHtml(t)}\n        </div>\n        <div id="lineEdit-${n+1}" class="hidden">\n          <textarea\n            id="lineTextarea-${n+1}"\n            style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #6366f1; border-radius: 12px; font-size: 16px; font-family: inherit; resize: vertical;"\n          >${escapeHtml(t)}</textarea>\n          <div style="display: flex; gap: 8px; margin-top: 8px;">\n            <button class="btn btn-secondary cancel-line-btn" data-line="${n+1}" style="padding: 8px 16px;">Cancel</button>\n            <button class="btn btn-primary save-line-btn" data-line="${n+1}" style="padding: 8px 16px;">Save</button>\n          </div>\n        </div>\n      </div>\n    `).join("")}\n  `,attachModalEditListeners(),document.getElementById("storyModal").classList.add("active")}function attachModalEditListeners(){const e=document.getElementById("editTitleBtn"),t=document.getElementById("titleDisplay"),n=document.getElementById("cancelTitleBtn"),i=document.getElementById("saveTitleBtn");e&&e.addEventListener("click",()=>{document.getElementById("titleDisplay").classList.add("hidden"),document.getElementById("titleEdit").classList.remove("hidden"),document.getElementById("titleInput").focus()}),t&&t.addEventListener("click",()=>{document.getElementById("titleDisplay").classList.add("hidden"),document.getElementById("titleEdit").classList.remove("hidden"),document.getElementById("titleInput").focus()}),n&&n.addEventListener("click",()=>{document.getElementById("titleDisplay").classList.remove("hidden"),document.getElementById("titleEdit").classList.add("hidden")}),i&&i.addEventListener("click",()=>saveTitle());document.querySelectorAll(".edit-line-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.line;console.log("Edit line button clicked, line:",n),startEditLine(n)})});document.querySelectorAll(".cancel-line-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.line;console.log("Cancel line button clicked, line:",n),cancelEditLine(n)})});document.querySelectorAll(".save-line-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.line;console.log("Save line button clicked, line:",n),saveLine(n)})}),console.log("Modal edit listeners attached")}async function saveTitle(){const e=document.getElementById("titleInput").value.trim();if(!e)return void showNotification("Title cannot be empty","error");if(!appState.currentStory)return;const t=document.getElementById("saveTitleBtn"),n=t.innerHTML;try{t.disabled=!0,t.innerHTML='\n      <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block;" viewBox="0 0 24 24">\n        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>\n        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/>\n      </svg>\n      <span style="margin-left: 4px;">Saving...</span>\n    ';const n=await window.Clerk.session.getToken(),i=await fetchWithRetry(`/api/ai/update-story/${appState.currentStory.id}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({title:e})}),s=await i.json();if(s.success){appState.currentStory.title=e;const t=appState.stories.findIndex(e=>e.id===appState.currentStory.id);-1!==t&&(appState.stories[t].title=e),document.getElementById("titleDisplay").textContent=e,document.getElementById("titleDisplay").classList.remove("hidden"),document.getElementById("titleEdit").classList.add("hidden"),renderStories(appState.filteredStories),showNotification("Title updated successfully!","success")}else showNotification("Error updating title: "+s.error,"error")}catch(e){showNotification(handleApiError(e,"updating title"),"error")}finally{t.disabled=!1,t.innerHTML=n}}function startEditLine(e){document.getElementById(`lineDisplay-${e}`).classList.add("hidden"),document.getElementById(`lineEdit-${e}`).classList.remove("hidden"),document.getElementById(`lineTextarea-${e}`).focus()}function cancelEditLine(e){document.getElementById(`lineDisplay-${e}`).classList.remove("hidden"),document.getElementById(`lineEdit-${e}`).classList.add("hidden")}async function saveLine(e){const t=document.getElementById(`lineTextarea-${e}`).value.trim();if(!t)return void showNotification("Line cannot be empty","error");if(!appState.currentStory)return;const n=document.querySelector(`.save-line-btn[data-line="${e}"]`),i=n.innerHTML;try{n.disabled=!0,n.innerHTML='\n      <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block;" viewBox="0 0 24 24">\n        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>\n        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/>\n      </svg>\n      <span style="margin-left: 4px;">Saving...</span>\n    ';const i=await window.Clerk.session.getToken(),s=JSON.parse(appState.currentStory.ai_response);s[`line${e}`]=t;const o=await fetchWithRetry(`/api/ai/update-story/${appState.currentStory.id}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({ai_response:JSON.stringify(s)})}),a=await o.json();if(a.success){appState.currentStory.ai_response=JSON.stringify(s);const n=appState.stories.findIndex(e=>e.id===appState.currentStory.id);-1!==n&&(appState.stories[n].ai_response=JSON.stringify(s)),document.getElementById(`lineDisplay-${e}`).textContent=t,document.getElementById(`lineDisplay-${e}`).classList.remove("hidden"),document.getElementById(`lineEdit-${e}`).classList.add("hidden"),renderStories(appState.filteredStories),showNotification(`Line ${e} updated successfully!`,"success")}else showNotification("Error updating line: "+a.error,"error")}catch(e){showNotification(handleApiError(e,"updating line"),"error")}finally{n.disabled=!1,n.innerHTML=i}}function closeModal(){document.getElementById("storyModal").classList.remove("active"),appState.currentStory=null}function shareStory(e){const t=appState.stories.find(t=>t.id===e);if(!t)return;const n=JSON.parse(t.ai_response),i=`My Story:\n\n${Object.entries(n).map(([e,t],n)=>`${n+1}. ${t}`).join("\n\n")}\n\nCreated with StoryMaking.AI`;navigator.clipboard.writeText(i).then(()=>{showNotification("Story copied to clipboard! ðŸ“‹")}).catch(e=>{alert("Could not copy to clipboard")})}function shareCurrentStory(){appState.currentStory&&shareStory(appState.currentStory.id)}async function deleteStory(e){if(!confirm("Delete this story? This action cannot be undone."))return;const t=document.querySelector(`.delete-btn[data-story-id="${e}"]`);let n=null;try{t&&(n=t.innerHTML,t.disabled=!0,t.innerHTML='\n        <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" viewBox="0 0 24 24">\n          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/>\n          <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/>\n        </svg>\n      ');const i=await window.Clerk.session.getToken(),s=await fetchWithRetry(`/api/ai/history/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${i}`}}),o=await s.json();o.success?(showNotification("Story deleted successfully","success"),appState.stories=appState.stories.filter(t=>t.id!==e),appState.filteredStories=appState.filteredStories.filter(t=>t.id!==e),renderStories(appState.filteredStories),appState.currentStory&&appState.currentStory.id===e&&closeModal()):showNotification("Error deleting story: "+o.error,"error")}catch(e){showNotification(handleApiError(e,"deleting story"),"error")}finally{t&&n&&(t.disabled=!1,t.innerHTML=n)}}function showNotification(e,t="success"){const n=document.createElement("div"),i={success:"#10b981",error:"#ef4444",info:"#6366f1"};n.style.cssText=`\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    background: ${i[t]||i.success};\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    z-index: 1000;\n    animation: slideIn 0.3s ease-out;\n    max-width: 400px;\n  `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-out",setTimeout(()=>n.remove(),300)},"error"===t?5e3:3e3)}document.getElementById("storyModal").addEventListener("click",e=>{"storyModal"===e.target.id&&closeModal()});const style=document.createElement("style");style.textContent="\n  @keyframes slideIn {\n    from {\n      transform: translateX(400px);\n      opacity: 0;\n    }\n    to {\n      transform: translateX(0);\n      opacity: 1;\n    }\n  }\n  \n  @keyframes slideOut {\n    from {\n      transform: translateX(0);\n      opacity: 1;\n    }\n    to {\n      transform: translateX(400px);\n      opacity: 0;\n    }\n  }\n",document.head.appendChild(style),document.addEventListener("keydown",e=>{"Escape"===e.key&&closeModal()});